# --- base build stage
FROM python:3.8.16-bullseye as production

RUN whoami # root

# Below is based on AWS neuron documentation for compilation only: https://awsdocs-neuron.readthedocs-hosted.com/en/latest/frameworks/torch/torch-neuron/setup/pytorch-install.html#id2

# Set Pip repository  to point to the Neuron repository
RUN pip config set global.extra-index-url https://pip.repos.neuron.amazonaws.com

COPY requirements-base.txt requirements-production.txt

# install base dependencies, including neuron PyTorch
RUN pip install -r requirements-production.txt \
    --no-cache-dir

# --- test build stage
FROM production as development

# install test dependencies for access to off-the-shelf models
RUN pip install -r requirements-development.txt \
    --no-cache-dir

COPY requirements-test.txt requirements-development.txt
COPY conftest.py conftest.py
COPY test.py test.py

# run neuron compilation test suite
RUN pytest test.py