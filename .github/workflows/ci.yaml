---
name       : ML-mesh CI Workflow

on         :
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
    types:
      - ready_for_review
      - opened
      - synchronize
      - reopened

concurrency:
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}
  group: Deployment ${{ github.ref_name }}

jobs       :

  # ===============================================
  # QUALITY CHECKS
  # ===============================================

  run-code-quality-checks:
    name: Run Pre-Commit Checks
    uses: ./.github/workflows/_code-quality.yaml
    with:
      environment: prod
      pull-request: false # run pre commit suite on all files, but retain toggle logic in _code-quality flow for now
      timeout: 10

  # ===============================================
  # GET REPOSITORY STATE
  # ===============================================

  run-repository-state:
    name: Get Repository metadata
    uses: ./.github/workflows/_repository-state.yaml
    needs: [run-code-quality-checks]
    with:
      event-name: ${{ github.event_name }}
      push-target-branch: ${{ github.ref_name }}
      pull-request-target-branch: ${{ github.base_ref }}
      verbose: true
    secrets:
      GITHUB_TOKEN_: ${{ secrets.GITHUB_TOKEN }}

  check-repository-state:
    name: Check repository metadata
    needs: [run-repository-state]
    runs-on: ubuntu-20.04

    steps:
      - name: Show captured repository state
        run: |
          echo Target branch: ${{ needs.run-repository-state.outputs.target-branch }}
          echo "(Release) tag:" ${{ needs.run-repository-state.outputs.tag }}
          echo ${{ toJSON(needs.run-repository-state.outputs.release-notes) }}

  # ===============================================
  # TEST LIBS
  # ===============================================

  run-libs-tests:
    name: Run libraries unit and integration tests.
    uses: ./.github/workflows/_libs.yaml
    needs: [run-repository-state]

    strategy:
      max-parallel: 10
      fail-fast: ${{ needs.run-repository-state.outputs.target-branch == 'develop' }} # fixed. desired: TRUE for feature PR & PUSH events
      matrix:
        python-version: [3.8.16]
        poetry-version: [1.3.2]
        libs:
          - name: core
            integration: false
            functional: false

          - name: compile
            integration: false
            functional: false

          - name: models
            integration: false
            functional: false

          - name: serving
            integration: false
            functional: false

          - name: tracking
            integration: false
            functional: false # TODO: turn this to true when self hosted runners are available.

          - name: nlp
            integration: false
            functional: false

          - name: hashing
            integration: false
            functional: false

          - name: data
            integration: false
            functional: false

    with:
      lib: ${{ matrix.libs.name }}
      integration: ${{ matrix.libs.integration }}
      functional: ${{ matrix.libs.functional }}
      python-version: ${{ matrix.python-version }}
      poetry-version: ${{ matrix.poetry-version }}
      pull-request: ${{ github.event_name == 'pull_request' }}
      release: ${{ needs.run-repository-state.outputs.target-branch == 'main' || github.actor == 'dependabot[bot]' }}

  # ===============================================
  # DOCKER
  # ===============================================

  run-us-east-1-docker:
    name: Core Docker Images.
    uses: ./.github/workflows/_docker.yaml
    needs: [run-repository-state, run-libs-tests]
    strategy:
      max-parallel: 1
      fail-fast: ${{ needs.run-repository-state.outputs.target-branch == 'develop' }} # fixed. desired: TRUE for feature PR & PUSH events
      matrix:
        image:
          - python-base
          - gpu-base
          - gpu-train
          - neuron-compile
          - neuron-inference
          - fastapi-serve
        validate-build: [false]
        region: [us-east-1]

    with:
      environment: prod
      image: ${{ matrix.image }}
      region: ${{ matrix.region }}
      tag: ${{ needs.run-repository-state.outputs.tag }}
      pull-request: ${{ github.event_name == 'pull_request' }}
      validate-build: ${{ matrix.validate-build }}
      release: ${{ needs.run-repository-state.outputs.target-branch == 'main' || github.actor == 'dependabot[bot]' }}
    secrets:
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

  run-us-east-2-docker:
    name: Core Kubeflow Docker Images.
    uses: ./.github/workflows/_docker.yaml
    needs: [run-repository-state, run-libs-tests, run-us-east-1-docker]
    strategy:
      max-parallel: 1
      fail-fast: ${{ needs.run-repository-state.outputs.target-branch == 'develop' }} # fixed. desired: TRUE for feature PR & PUSH events
      matrix:
        image:
          - name: kubeflow-jupyter
            base-region: us-east-1
          - name: kubeflow-torch-cpu
            base-region: us-east-2
          - name: kubeflow-data-science
            base-region: us-east-2
          - name: kubeflow-torch-gpu
            base-region: us-east-1
          - name: dask-base
            base-region: us-east-1
          - name: kubeflow-torch-inf
            base-region: us-east-1
        validate-build: [false]
        region: [us-east-2]

    with:
      environment: prod
      image: ${{ matrix.image.name }}
      region: ${{ matrix.region }}
      base-region: ${{ matrix.image.base-region }}
      tag: ${{ needs.run-repository-state.outputs.tag }}
      pull-request: ${{ github.event_name == 'pull_request' }}
      validate-build: ${{ matrix.validate-build }}
      release: ${{ needs.run-repository-state.outputs.target-branch == 'main' || github.actor == 'dependabot[bot]' }}
    secrets:
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

  # ===============================================
  # PROJECTS
  # ===============================================

  # keywords

  run-keywords-project:
    name: Keywords Project components
    uses: ./.github/workflows/_projects.yaml
    needs: [run-repository-state, run-libs-tests]
    strategy:
      max-parallel: 5
      fail-fast: ${{ needs.run-repository-state.outputs.target-branch == 'develop' }} # fixed. desired: TRUE for feature PR & PUSH events
      matrix:
        components:
          # NOTE: list of project components to run

          # train
          - name: train
            download-model: false
            integration: false
            functional: false
            load: false
            upload-test-results: false
            runner-kind: ubuntu-20.04

          # compile
          - name: compile
            download-model: false
            integration: false
            functional: false
            load: false
            upload-test-results: false
            runner-kind: ubuntu-20.04

          # serve
          - name: serve
            download-model: true
            integration: true
            functional: true
            load: true
            upload-test-results: true
            runner-kind: custom
            self-hosted-runner-type: inf1.xlarge

    with:
      project: keywords
      environment: prod
      component: ${{ matrix.components.name }}
      tag: ${{ needs.run-repository-state.outputs.tag }}
      download-model: ${{ matrix.components.download-model }}
      integration: ${{ matrix.components.integration }}
      functional: ${{ matrix.components.functional }}
      load: ${{ matrix.components.load }}
      upload-test-results: ${{ matrix.components.upload-test-results }}
      pull-request: ${{ github.event_name == 'pull_request' }}
      release: ${{ needs.run-repository-state.outputs.target-branch == 'main' || github.actor == 'dependabot[bot]' }}
      runner-kind: ${{ matrix.components.runner-kind }}
      self-hosted-runner-type: ${{ matrix.components.self-hosted-runner-type }}
    secrets:
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      GH_PERSONAL_ACCESS_TOKEN: ${{ secrets.GH_PERSONAL_ACCESS_TOKEN }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      NEPTUNE_API_TOKEN: ${{ secrets.NEPTUNE_API_TOKEN }}
      INTERNAL_ML_ENDPOINT_API_KEY: ${{ secrets.INTERNAL_ML_ENDPOINT_API_KEY }}

  # summarization

  run-summarization-project:
    name: Summarization Project components
    uses: ./.github/workflows/_projects.yaml
    needs: [run-repository-state, run-libs-tests]
    strategy:
      max-parallel: 10
      fail-fast: ${{ needs.run-repository-state.outputs.target-branch == 'develop' }} # fixed. desired: TRUE for feature PR & PUSH events
      matrix:
        components:
          # NOTE: list of project components to run

          # serve
          - name: serve
            download-model: false
            integration: false
            functional: false
            load: false
            upload-test-results: false
            runner-kind: ubuntu-20.04

    with:
      project: summarization
      environment: prod
      component: ${{ matrix.components.name }}
      tag: ${{ needs.run-repository-state.outputs.tag }}
      download-model: ${{ matrix.components.download-model }}
      integration: ${{ matrix.components.integration }}
      functional: ${{ matrix.components.functional }}
      load: ${{ matrix.components.load }}
      upload-test-results: ${{ matrix.components.upload-test-results }}
      pull-request: ${{ github.event_name == 'pull_request' }}
      release: ${{ needs.run-repository-state.outputs.target-branch == 'main' || github.actor == 'dependabot[bot]' }}
      runner-kind: ${{ matrix.components.runner-kind }}
      self-hosted-runner-type: ${{ matrix.components.self-hosted-runner-type }}
    secrets:
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      GH_PERSONAL_ACCESS_TOKEN: ${{ secrets.GH_PERSONAL_ACCESS_TOKEN }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      NEPTUNE_API_TOKEN: ${{ secrets.NEPTUNE_API_TOKEN }}
      INTERNAL_ML_ENDPOINT_API_KEY: ${{ secrets.INTERNAL_ML_ENDPOINT_API_KEY }}

  # entity-linking

  run-entity-linking-project:
    name: Entity Linking Project components
    uses: ./.github/workflows/_projects.yaml
    needs: [run-repository-state, run-libs-tests]
    strategy:
      max-parallel: 10
      fail-fast: ${{ needs.run-repository-state.outputs.target-branch == 'develop' }} # fixed. desired: TRUE for feature PR & PUSH events
      matrix:
        components:
          # NOTE: list of project components to run

          # serve
          - name: serve
            download-model: true
            integration: true
            functional: true
            load: false
            upload-test-results: false
            runner-kind: custom
            self-hosted-runner-type: inf1.xlarge

    with:
      project: entity-linking
      environment: prod
      component: ${{ matrix.components.name }}
      tag: ${{ needs.run-repository-state.outputs.tag }}
      download-model: ${{ matrix.components.download-model }}
      integration: ${{ matrix.components.integration }}
      functional: ${{ matrix.components.functional }}
      load: ${{ matrix.components.load }}
      upload-test-results: ${{ matrix.components.upload-test-results }}
      pull-request: ${{ github.event_name == 'pull_request' }}
      release: ${{ needs.run-repository-state.outputs.target-branch == 'main' || github.actor == 'dependabot[bot]' }}
      runner-kind: ${{ matrix.components.runner-kind }}
      self-hosted-runner-type: ${{ matrix.components.self-hosted-runner-type }}
    secrets:
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      GH_PERSONAL_ACCESS_TOKEN: ${{ secrets.GH_PERSONAL_ACCESS_TOKEN }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      NEPTUNE_API_TOKEN: ${{ secrets.NEPTUNE_API_TOKEN }}
      INTERNAL_ML_ENDPOINT_API_KEY: ${{ secrets.INTERNAL_ML_ENDPOINT_API_KEY }}


  # sentiment

  run-sentiment-project:
    name: Sentiment Project components
    uses: ./.github/workflows/_projects.yaml
    needs: [run-repository-state, run-libs-tests]
    strategy:
      max-parallel: 10
      fail-fast: ${{ needs.run-repository-state.outputs.target-branch == 'develop' }} # fixed. desired: TRUE for feature PR & PUSH events
      matrix:
        components:
          # NOTE: list of project components to run

          # train
          - name: train
            download-model: false
            integration: false
            functional: false
            load: false
            upload-test-results: false
            runner-kind: ubuntu-20.04

          # compile
          - name: compile
            download-model: false
            integration: false
            functional: false
            load: false
            upload-test-results: false
            runner-kind: ubuntu-20.04

          # serve
          - name: serve
            download-model: true
            integration: true
            functional: true
            load: true
            upload-test-results: true
            runner-kind: custom
            self-hosted-runner-type: inf1.xlarge

    with:
      project: sentiment
      environment: prod
      component: ${{ matrix.components.name }}
      tag: ${{ needs.run-repository-state.outputs.tag }}
      download-model: ${{ matrix.components.download-model }}
      integration: ${{ matrix.components.integration }}
      functional: ${{ matrix.components.functional }}
      load: ${{ matrix.components.load }}
      upload-test-results: ${{ matrix.components.upload-test-results }}
      pull-request: ${{ github.event_name == 'pull_request' }}
      release: ${{ needs.run-repository-state.outputs.target-branch == 'main' || github.actor == 'dependabot[bot]' }}
      runner-kind: ${{ matrix.components.runner-kind }}
      self-hosted-runner-type: ${{ matrix.components.self-hosted-runner-type }}
    secrets:
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      GH_PERSONAL_ACCESS_TOKEN: ${{ secrets.GH_PERSONAL_ACCESS_TOKEN }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      NEPTUNE_API_TOKEN: ${{ secrets.NEPTUNE_API_TOKEN }}
      INTERNAL_ML_ENDPOINT_API_KEY: ${{ secrets.INTERNAL_ML_ENDPOINT_API_KEY }}

  # ner

  run-ner-project:
    name: NER Project components
    uses: ./.github/workflows/_projects.yaml
    needs: [run-repository-state, run-libs-tests]
    strategy:
      max-parallel: 10
      fail-fast: ${{ needs.run-repository-state.outputs.target-branch == 'develop' }} # fixed. desired: TRUE for feature PR & PUSH events
      matrix:
        components:
          # NOTE: list of project components to run

          # train
          - name: train
            download-model: false
            integration: false
            functional: false
            load: false
            upload-test-results: false
            runner-kind: ubuntu-20.04

          # compile
          - name: compile
            download-model: false
            integration: false
            functional: false
            load: false
            upload-test-results: false
            runner-kind: ubuntu-20.04

          # serve
          - name: serve
            download-model: true
            integration: false
            functional: true
            load: true
            upload-test-results: true
            runner-kind: custom
            self-hosted-runner-type: inf1.xlarge

    with:
      project: ner
      environment: prod
      component: ${{ matrix.components.name }}
      tag: ${{ needs.run-repository-state.outputs.tag }}
      download-model: ${{ matrix.components.download-model }}
      integration: ${{ matrix.components.integration }}
      functional: ${{ matrix.components.functional }}
      load: ${{ matrix.components.load }}
      upload-test-results: ${{ matrix.components.upload-test-results }}
      pull-request: ${{ github.event_name == 'pull_request' }}
      release: ${{ needs.run-repository-state.outputs.target-branch == 'main' || github.actor == 'dependabot[bot]' }}
      runner-kind: ${{ matrix.components.runner-kind }}
      self-hosted-runner-type: ${{ matrix.components.self-hosted-runner-type }}
    secrets:
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      GH_PERSONAL_ACCESS_TOKEN: ${{ secrets.GH_PERSONAL_ACCESS_TOKEN }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      NEPTUNE_API_TOKEN: ${{ secrets.NEPTUNE_API_TOKEN }}
      INTERNAL_ML_ENDPOINT_API_KEY: ${{ secrets.INTERNAL_ML_ENDPOINT_API_KEY }}

  # lsh

  run-lsh-project:
    name: LSH Project components
    uses: ./.github/workflows/_projects.yaml
    needs: [run-repository-state, run-libs-tests]
    strategy:
      max-parallel: 10
      fail-fast: ${{ needs.run-repository-state.outputs.target-branch == 'develop' }} # fixed. desired: TRUE for feature PR & PUSH events
      matrix:
        components:
          # NOTE: list of project components to run

          # serve
          - name: serve
            download-model: false
            integration: false
            functional: false
            load: false
            upload-test-results: false
            runner-kind: ubuntu-20.04

    with:
      project: lsh
      environment: prod
      component: ${{ matrix.components.name }}
      tag: ${{ needs.run-repository-state.outputs.tag }}
      download-model: ${{ matrix.components.download-model }}
      integration: ${{ matrix.components.integration }}
      functional: ${{ matrix.components.functional }}
      load: ${{ matrix.components.load }}
      upload-test-results: ${{ matrix.components.upload-test-results }}
      pull-request: ${{ github.event_name == 'pull_request' }}
      release: ${{ needs.run-repository-state.outputs.target-branch == 'main' || github.actor == 'dependabot[bot]' }}
      runner-kind: ${{ matrix.components.runner-kind }}
      self-hosted-runner-type: ${{ matrix.components.self-hosted-runner-type }}
    secrets:
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      GH_PERSONAL_ACCESS_TOKEN: ${{ secrets.GH_PERSONAL_ACCESS_TOKEN }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      NEPTUNE_API_TOKEN: ${{ secrets.NEPTUNE_API_TOKEN }}
      INTERNAL_ML_ENDPOINT_API_KEY: ${{ secrets.INTERNAL_ML_ENDPOINT_API_KEY }}

  # ===============================================
  # TRAIN MODELS
  # ===============================================

  run-train-pipelines:
    name: Train ML models
    uses: ./.github/workflows/_train_model.yaml
    needs:
      - run-repository-state
      - run-keywords-project
      - run-summarization-project
      - run-sentiment-project
      - run-ner-project
      - run-lsh-project

    strategy:
      fail-fast: ${{ needs.run-repository-state.outputs.target-branch == 'develop' }}
      matrix:
        models:
          - project: keywords
            sagemaker-runner-type: ml.m4.xlarge
            tag: ${{ needs.run-repository-state.outputs.tag }}
          - project: ner
            sagemaker-runner-type: ml.m4.xlarge
            tag: ${{ needs.run-repository-state.outputs.tag }}
    with:
      environment: prod
      project: ${{ matrix.models.project }}
      sagemaker-runner-type: ${{ matrix.models.sagemaker-runner-type }}
      tag: ${{ matrix.models.tag }}
      python-version: 3.8.16
      poetry-version: 1.3.2
      release: ${{ needs.run-repository-state.outputs.target-branch == 'main' || github.actor == 'dependabot[bot]' }}
    secrets:
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      GH_PERSONAL_ACCESS_TOKEN: ${{ secrets.GH_PERSONAL_ACCESS_TOKEN }}
      NEPTUNE_API_TOKEN: ${{ secrets.NEPTUNE_API_TOKEN }}

  # ===============================================
  # COMPILE MODELS
  # ===============================================

  run-compilation-pipelines:
    name: Compile ML models
    uses: ./.github/workflows/_compile_model.yaml
    needs:
      - run-repository-state
      - run-keywords-project
      - run-summarization-project
      - run-sentiment-project
      - run-ner-project
      - run-lsh-project
      - run-train-pipelines

    strategy:
      fail-fast: ${{ needs.run-repository-state.outputs.target-branch == 'develop' }}
      matrix:
        models:
          - runner-kind: custom
            self-hosted-runner-type: inf1.2xlarge
            project: keywords
            tag: ${{ needs.run-repository-state.outputs.tag }}

          - runner-kind: custom
            self-hosted-runner-type: inf1.2xlarge
            project: ner
            tag: ${{ needs.run-repository-state.outputs.tag }}

          - runner-kind: custom
            self-hosted-runner-type: inf1.2xlarge
            project: sentiment
            tag: ${{ needs.run-repository-state.outputs.tag }}

    with:
      environment: prod
      runner-kind: ${{ matrix.models.runner-kind }}
      self-hosted-runner-type: ${{ matrix.models.self-hosted-runner-type }}
      project: ${{ matrix.models.project }}
      tag: ${{ matrix.models.tag }}
      release: ${{ needs.run-repository-state.outputs.target-branch == 'main' || github.actor == 'dependabot[bot]' }}
      upload-compiled-model: true
    secrets:
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      GH_PERSONAL_ACCESS_TOKEN: ${{ secrets.GH_PERSONAL_ACCESS_TOKEN }}
      NEPTUNE_API_TOKEN: ${{ secrets.NEPTUNE_API_TOKEN }}

  # ===============================================
  # APPS
  # ===============================================

  run-apps:
    name: Web Applications
    uses: ./.github/workflows/_apps.yaml
    needs: [run-repository-state, run-libs-tests]
    strategy:
      max-parallel: 10
      fail-fast: ${{ needs.run-repository-state.outputs.target-branch == 'develop' }}
      matrix:
        apps:
          # NOTE: list of apps components to run

          # ========================
          # Prompt manager
          # ========================

          - name: prompt
            component: backend
            integration: true

          - name: prompt
            component: frontend
            integration: false

          - name: entity-fishing
            component: backend
            integration: false

    with:
      environment: prod
      app: ${{ matrix.apps.name }}
      component: ${{ matrix.apps.component }}
      tag: ${{ needs.run-repository-state.outputs.tag }}
      integration: ${{ matrix.apps.integration }}
      pull-request: ${{ github.event_name == 'pull_request' }}
      release: ${{ needs.run-repository-state.outputs.target-branch == 'main' || github.actor == 'dependabot[bot]' }}
    secrets:
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
