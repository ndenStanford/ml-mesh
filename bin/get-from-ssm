"""Populate .env file from secret manager secrets."""

import os

import click
import boto3


ROOT_DIR = os.path.dirname(
    os.path.dirname(
        os.path.realpath(__file__)
    )
)

def get_parameter(name: str, region: str) -> str:
    session = boto3.Session()
    client = session.client(
        service_name='ssm',
        region_name=region
    )
    
    param = client.get_parameter(Name=name, WithDecryption=True)
    return param["Parameter"]["Value"]


def append_secrets_to_env_file(secret, value, prepend_with_export=True):
    ""
    export_keyword = "export "
    if not prepend_with_export:
        export_keyword = ""
        print("Export will not be prepended")

    if os.path.exists(os.path.join(ROOT_DIR, '.envrc')):
        writemode = 'a+'
    else:
        writemode = 'w+'

    file = open(os.path.join(ROOT_DIR, '.envrc'), writemode)
    escaped_value = value.translate(str.maketrans({
        "\"": "\\\"",
        "\n": ""
    }))
    file.write("{}{}=\"{}\"\n".format(export_keyword, secret, escaped_value))
    file.close()


@click.command()
@click.argument("secret")
@click.option(
    "--name",
    "-n",
    help="Environment Variable name."
)
@click.option(
    "--region",
    "-r",
    help="AWS region.",
    default="us-east-1"
)
def main(secret, name, region):
    append_secrets_to_env_file(name, get_parameter(secret, region))


if __name__ == "__main__":
    main()
