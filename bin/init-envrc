"""Populate .env file from secret manager secrets."""

import os
import click
import getpass
import boto3


ROOT_DIR = os.path.dirname(
    os.path.dirname(
        os.path.realpath(__file__)
    )
)

def append_secrets_to_env_file(secret, value, prepend_with_export=True):
    "Add secrets to environment file."
    export_keyword = "export "
    if not prepend_with_export:
        export_keyword = ""
        print("Export will not be prepended")

    if os.path.exists(os.path.join(ROOT_DIR, '.envrc')):
        writemode = 'a+'
    else:
        writemode = 'w+'

    file = open(os.path.join(ROOT_DIR, '.envrc'), writemode)
    escaped_value = value.translate(str.maketrans({
        "\"": "\\\"",
        "\n": ""
    }))
    file.write("{}{}=\"{}\"\n".format(export_keyword, secret, escaped_value))
    file.close()

@click.command()
@click.option(
    "--profile",
    "-p",
    help="AWS account to select.",
    default="dev"
)
def main(profile: str):
    append_secrets_to_env_file("AWS_PROFILE", profile)
    append_secrets_to_env_file("AWS_ACCOUNT_ID", boto3.client('sts').get_caller_identity().get('Account'))
    append_secrets_to_env_file("IMAGE_TAG", getpass.getuser())
    append_secrets_to_env_file("BASE_IMAGE_TAG", getpass.getuser())

if __name__ == "__main__":
    main()
